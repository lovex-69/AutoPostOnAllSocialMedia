<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>ExecutionPosting • Music Manager</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#fafbfc;--surface:#fff;--surface-2:#f4f5f7;--border:#e2e4e9;
  --text:#1a1d23;--text-dim:#6b7280;--accent:#5046e5;--accent-light:#ede9fe;
  --green:#059669;--green-bg:#ecfdf5;--red:#dc2626;--red-bg:#fef2f2;
  --radius:12px;--shadow:0 1px 3px rgba(0,0,0,.06),0 1px 2px rgba(0,0,0,.04);
  --font:'Inter',system-ui,-apple-system,sans-serif;
}
body{font-family:var(--font);background:var(--bg);color:var(--text);line-height:1.6;min-height:100vh}
.app{max-width:1100px;margin:0 auto;padding:1.5rem 1rem 3rem;display:none}
.topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.2rem;padding-bottom:1rem;border-bottom:1px solid var(--border)}
.topbar h1{font-size:1.3rem;font-weight:800;color:var(--accent)}
.topbar-right{display:flex;align-items:center;gap:.7rem}
.server-dot{width:8px;height:8px;border-radius:50%;display:inline-block;background:var(--green)}
.server-label{font-size:.78rem;font-weight:600;color:var(--text-dim)}
.page-tabs{display:flex;gap:.4rem;margin:-.1rem 0 1rem}
.page-tab{display:inline-flex;align-items:center;justify-content:center;padding:.45rem .8rem;border:1px solid var(--border);border-radius:8px;font-size:.8rem;font-weight:600;color:var(--text-dim);text-decoration:none;background:var(--surface)}
.page-tab:hover{border-color:var(--accent);color:var(--accent);text-decoration:none}
.page-tab.active{background:var(--accent-light);border-color:var(--accent);color:var(--accent)}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:1.2rem;box-shadow:var(--shadow)}
.grid{display:grid;grid-template-columns:1fr 1.6fr;gap:1rem}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
.field{margin-bottom:.8rem}
.field label{display:block;font-size:.75rem;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.4px;margin-bottom:.3rem}
.input{width:100%;padding:.65rem .8rem;border:1.5px solid var(--border);border-radius:8px;font:inherit;font-size:.9rem;background:var(--surface)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:.4rem;padding:.55rem .9rem;font:inherit;font-size:.84rem;font-weight:600;border:none;border-radius:8px;cursor:pointer}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:disabled{opacity:.5;cursor:not-allowed}
.btn-ghost{background:transparent;color:var(--text-dim);border:1.5px solid var(--border)}
.btn-red{background:var(--red-bg);border:1px solid #fecaca;color:var(--red)}
.btn-full{width:100%}
.table{width:100%;border-collapse:collapse;font-size:.84rem}
.table th,.table td{padding:.55rem .4rem;border-bottom:1px solid var(--border);text-align:left;vertical-align:middle}
.table th{font-size:.72rem;text-transform:uppercase;letter-spacing:.4px;color:var(--text-dim)}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:.78rem}
.empty{padding:1.5rem;text-align:center;color:var(--text-dim);font-size:.86rem}
.toast{position:fixed;bottom:1.2rem;right:1.2rem;padding:.75rem 1rem;border-radius:9px;font-size:.83rem;font-weight:600;transform:translateY(120%);opacity:0;transition:all .3s;z-index:999;max-width:360px}
.toast.show{transform:translateY(0);opacity:1}
.toast.success{background:var(--green-bg);color:var(--green);border:1px solid #a7f3d0}
.toast.error{background:var(--red-bg);color:var(--red);border:1px solid #fca5a5}
.gate{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:1000}
.gate-box{width:min(380px,92%);background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:1.2rem;box-shadow:var(--shadow)}
.gate-box h2{font-size:1.2rem;font-weight:800;color:var(--accent);margin-bottom:.3rem}
.gate-box p{font-size:.85rem;color:var(--text-dim);margin-bottom:.8rem}
.gate-status{font-size:.82rem;min-height:1.1rem;margin-bottom:.8rem;color:var(--text-dim)}
</style>
</head>
<body>
<div class="gate" id="gate">
  <div class="gate-box">
    <h2>Music Manager</h2>
    <p>Manage songs in your Supabase music bucket.</p>
    <div class="field"><label>Access Key</label><input id="gateKey" type="password" class="input" placeholder="Enter secret key"/></div>
    <div class="gate-status" id="gateStatus">Checking server...</div>
    <button class="btn btn-primary btn-full" id="gateBtn">Connect</button>
  </div>
</div>

<div class="app" id="app">
  <div class="topbar">
    <h1>ExecutionPosting</h1>
    <div class="topbar-right">
      <span class="server-dot"></span>
      <span class="server-label">Music bucket online</span>
      <button class="btn btn-ghost" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="page-tabs">
    <a class="page-tab" href="/">Content Manager</a>
    <a class="page-tab active" href="/static/music.html">Music Manager</a>
  </div>

  <div class="grid">
    <div class="card">
      <h3 style="font-size:1rem;margin-bottom:.8rem">Upload Song</h3>
      <div class="field"><label>Audio file</label><input id="musicFile" class="input" type="file" accept=".mp3,.wav,.ogg,.m4a,.flac,.aac"/></div>
      <div class="field"><label>Folder (optional)</label><input id="musicFolder" class="input" placeholder="e.g. bgm/lofi"/></div>
      <div class="field"><label><input id="musicUpsert" type="checkbox"/> Overwrite if file exists</label></div>
      <button class="btn btn-primary btn-full" id="uploadBtn">Upload to bucket</button>
      <p style="margin-top:.7rem;font-size:.78rem;color:var(--text-dim)">Allowed: MP3, WAV, OGG, M4A, FLAC, AAC</p>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.8rem">
        <h3 style="font-size:1rem">Songs in Bucket</h3>
        <button class="btn btn-ghost" id="refreshBtn">Refresh</button>
      </div>
      <div style="overflow:auto">
        <table class="table" id="musicTable" style="display:none">
          <thead>
            <tr><th>Name</th><th>Path</th><th>Size</th><th>Action</th></tr>
          </thead>
          <tbody id="musicBody"></tbody>
        </table>
      </div>
      <div class="empty" id="emptyState">Loading songs...</div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="config.js"></script>
<script>
const A = window.EXECUTION_API_URL || '';

function auth(){return sessionStorage.getItem('ep_k') || '';}
function headers(){return {'X-Auth-Key': auth()};}
function esc(s){const d=document.createElement('div');d.textContent=s || '';return d.innerHTML;}
function toast(msg,type='success'){const e=document.getElementById('toast');e.textContent=msg;e.className=`toast ${type} show`;setTimeout(()=>e.classList.remove('show'),3500);}
function bytes(v){if(typeof v!=='number')return '—';if(v<1024)return `${v} B`;if(v<1024*1024)return `${(v/1024).toFixed(1)} KB`;return `${(v/(1024*1024)).toFixed(2)} MB`;}
function encodeObjectPath(path){return String(path).split('/').map(encodeURIComponent).join('/');}
function logout(){sessionStorage.removeItem('ep_k');location.reload();}

async function serverUp(){try{const r=await fetch(`${A}/health`,{signal:AbortSignal.timeout(8000)});return r.ok;}catch{return false;}}
async function checkAuth(key){try{const r=await fetch(`${A}/api/tools`,{headers:{'X-Auth-Key':key},signal:AbortSignal.timeout(10000)});return r.ok;}catch{return false;}}

async function loadSongs(){
  const empty=document.getElementById('emptyState');
  const table=document.getElementById('musicTable');
  const body=document.getElementById('musicBody');
  empty.style.display='block';
  table.style.display='none';
  empty.textContent='Loading songs...';
  try{
    const r=await fetch(`${A}/api/music`,{headers:headers(),signal:AbortSignal.timeout(15000)});
    const data=await r.json();
    if(!r.ok) throw new Error(data.detail || 'Failed to fetch songs');
    const items=Array.isArray(data.items)?data.items:[];
    if(items.length===0){
      empty.textContent='No songs found in bucket.';
      return;
    }
    body.innerHTML=items.map(item=>`
      <tr>
        <td>${esc(item.name)}</td>
        <td class="mono">${esc(item.path)}</td>
        <td>${bytes(item.size)}</td>
        <td><button class="btn btn-red" data-path="${esc(item.path)}">Delete</button></td>
      </tr>
    `).join('');
    body.querySelectorAll('button[data-path]').forEach(btn=>{
      btn.addEventListener('click',()=>deleteSong(btn.dataset.path || ''));
    });
    table.style.display='table';
    empty.style.display='none';
  }catch(err){
    empty.textContent='Could not load songs.';
    toast(err.message || 'Load failed','error');
  }
}

async function uploadSong(){
  const fileInput=document.getElementById('musicFile');
  const folder=document.getElementById('musicFolder').value.trim();
  const upsert=document.getElementById('musicUpsert').checked;
  const btn=document.getElementById('uploadBtn');
  const file=fileInput.files && fileInput.files[0];
  if(!file){toast('Select an audio file first','error');return;}

  const form=new FormData();
  form.append('file',file);
  if(folder) form.append('folder',folder);
  form.append('upsert',String(upsert));

  btn.disabled=true;btn.textContent='Uploading...';
  try{
    const r=await fetch(`${A}/api/music/upload`,{method:'POST',headers:headers(),body:form,signal:AbortSignal.timeout(60000)});
    const data=await r.json();
    if(!r.ok) throw new Error(data.detail || 'Upload failed');
    toast('Song uploaded successfully');
    fileInput.value='';
    await loadSongs();
  }catch(err){
    toast(err.message || 'Upload failed','error');
  }finally{
    btn.disabled=false;btn.textContent='Upload to bucket';
  }
}

async function deleteSong(path){
  if(!path)return;
  if(!confirm(`Delete ${path}?`))return;
  try{
    const safePath=encodeObjectPath(path);
    const r=await fetch(`${A}/api/music/${safePath}`,{method:'DELETE',headers:headers(),signal:AbortSignal.timeout(15000)});
    const data=await r.json();
    if(!r.ok) throw new Error(data.detail || 'Delete failed');
    toast('Song deleted');
    await loadSongs();
  }catch(err){
    toast(err.message || 'Delete failed','error');
  }
}

function enter(){
  document.getElementById('gate').style.display='none';
  document.getElementById('app').style.display='block';
  loadSongs();
}

async function connect(){
  const key=document.getElementById('gateKey').value.trim();
  const status=document.getElementById('gateStatus');
  if(!key){status.textContent='Enter your access key.';return;}
  status.textContent='Connecting...';
  const okServer=await serverUp();
  if(!okServer){status.textContent='Server is not reachable.';return;}
  const okAuth=await checkAuth(key);
  if(!okAuth){status.textContent='Invalid access key.';return;}
  sessionStorage.setItem('ep_k',key);
  enter();
}

document.getElementById('gateBtn').addEventListener('click',connect);
document.getElementById('uploadBtn').addEventListener('click',uploadSong);
document.getElementById('refreshBtn').addEventListener('click',loadSongs);

(async()=>{
  const status=document.getElementById('gateStatus');
  const key=auth();
  const up=await serverUp();
  if(up && key && await checkAuth(key)){enter();return;}
  status.textContent=up?'Server online. Enter key to continue.':'Server sleeping/offline.';
})();
</script>
</body>
</html>
